<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pantry</title>
    {% include 'header.html' %}
    <link rel="stylesheet" href="static/pantry.css">
    
</head>
<body>
    <div class="header">
      <img class="logo" src="static/logo.png" alt="logo">
      <h1>Pantry</h1>
    </div>
    <div class="search-container">
        <p>Search for the ingredients you currently have around, and click on it to add to your pantry.</p>
        <div class="search">
            <input type="text" id="SearchBox" oninput="filterOut()" placeholder="Search for ingredients">
            <div class="dropdown" id="dropdown">
                <ul id="Ingredients">
                    {% for ingredient in ingredients %}
                        <li data-ingredient="{{ingredient}}">{{ingredient}}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="top-buttons">
        <div class="button-group">
            <form action="/recommended_recipes">
                <input type="hidden" id="ing" name="ingredients" value="">
                <button id="recommend-button">Recommend Recipes</button>
            </form>
            <form action="/all_recipes">
                <button id="all-recipes-button">View All Recipes</button>
            </form>
        </div>
    </div>

    <div class="clear-all-container">
        <button id="clear-all-button">Clear All Pantry</button>
    </div>

    <div class="pantry-container">
        <h2>Your Pantry Items</h2>
        <div class="pantry-table-container">
            <table id="pantry-table">
                <thead>
                    <tr>
                        <th>Item</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in pantry_items %}
                        <tr>
                            <td>
                                {{ item }}
                                <button class="remove-button">Remove</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const removeButtons = document.querySelectorAll(".remove-button");
            removeButtons.forEach(button => {
                button.addEventListener("click", function () {
                    const row = button.closest("tr");
                    removeFromPantry(row);
                });
            });

            document.getElementById("clear-all-button").addEventListener("click", clearAllPantry);

            document.addEventListener("click", function (event) {
                const dropdown = document.getElementById("dropdown");
                const searchBox = document.getElementById("SearchBox");

                if (!dropdown.contains(event.target) && event.target !== searchBox) {
                    dropdown.style.display = "none";
                }
            });
        });

        document.getElementById("recommend-button").addEventListener("click", function () {
            const pantryItems = getPantryItems();
            document.getElementById("ing").value = JSON.stringify(pantryItems);
        });

        function filterOut() {
            const filter = document.getElementById("SearchBox").value.toUpperCase();
            const li = document.getElementById("Ingredients").getElementsByTagName("li");
            const dropdown = document.getElementById("dropdown");
            let hasVisibleItems = false;

            for (let i = 0; i < li.length; i++) {
                if (li[i].textContent.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                    hasVisibleItems = true;
                } else {
                    li[i].style.display = "none";
                }
            }

            dropdown.style.display = hasVisibleItems ? "block" : "none";
        }

        document.getElementById("Ingredients").addEventListener("click", function (event) {
            if (event.target.tagName === "LI") {
                const item = event.target.getAttribute("data-ingredient");
                addToPantry(item);
                document.getElementById("SearchBox").value = "";
                document.getElementById("dropdown").style.display = "none";
            }
        });

        function addToPantry(item) {
            const pantryTable = document.getElementById("pantry-table").getElementsByTagName("tbody")[0];
            const rows = pantryTable.getElementsByTagName("tr");

            for (let i = 0; i < rows.length; i++) {
                if (rows[i].cells[0].textContent.trim().replace("Remove", "").trim() === item) {
                    alert(`${item} is already in your pantry.`);
                    return;
                }
            }

            const row = document.createElement("tr");
            const itemCell = document.createElement("td");
            const itemText = document.createTextNode(item);
            const removeButton = document.createElement("button");

            removeButton.textContent = "Remove";
            removeButton.className = "remove-button";
            removeButton.addEventListener("click", function () {
                removeFromPantry(row);
            });

            itemCell.appendChild(itemText);
            itemCell.appendChild(removeButton);
            row.appendChild(itemCell);
            pantryTable.appendChild(row);

            savePantryItems();
        }

        function removeFromPantry(row) {
            const pantryTable = document.getElementById("pantry-table").getElementsByTagName("tbody")[0];
            pantryTable.removeChild(row);
            savePantryItems();
        }

        function clearAllPantry() {
            if (confirm("Are you sure you want to clear all pantry items?")) {
                const pantryTable = document.getElementById("pantry-table").getElementsByTagName("tbody")[0];
                pantryTable.innerHTML = "";
                savePantryItems();
            }
        }

        function savePantryItems() {
            const pantryItems = getPantryItems();
            fetch('/pantry/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'pantry_items': pantryItems })
            });
        }

        function getPantryItems() {
            const rows = document.querySelectorAll("#pantry-table tbody tr");
            return Array.from(rows).map(row =>
                row.cells[0].textContent.trim().replace("Remove", "").trim()
            );
        }
    </script>
</body>
</html>
