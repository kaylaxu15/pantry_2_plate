<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="static/styles.css">
    <title>Your Favorite Recipes</title>
    {% include 'header.html' %}
    <img class="logo" src="static/logo.png" alt="logo">

</head>
<body>
    <h1>Your Favorite Recipes</h1>
    <button onclick="history.back()" class="back-button">Go Back</button>
    <div class="search-box">
        <input type="text" id="search-input" name="search" placeholder="Search recipes...">
        <select id="search-type" name="search-type">
            <option value="all">All</option>
            <option value="title">Title</option>
            <option value="tags">Tags</option>
            <option value="difficulty">Skill Level</option>
        </select>
        <button onclick="searchRecipes()" class="search-button">Search</button>
    </div>

    <div class="favorite-container">
        {% if favRecipes %}
            {% for recipe in favRecipes %}
            <span class="inline-box" onclick="openModal('modal{{ loop.index }}')">
                <h4>{{ recipe.title | safe }}</h4>
                <img src="{{recipe.picture_url}}" width="150" height="150">
                <br></br>
                {% if recipe.servings != "" and recipe.servings == recipe.servings %}
                Number of Servings: {{ recipe.servings }}
                <br></br>
                {% elif recipe.makes != "" and recipe.makes == recipe.makes %}
                    Makes: {{ recipe.makes }}
                    <br></br>
                {% endif %}
                {% if recipe.difficulty in ['Easy', 'More effort', 'A challenge'] %}
                    {% if recipe.difficulty == 'Easy' %}
                        Skill level: Beginner
                    {% endif %}
                    {% if recipe.difficulty == 'More effort' %}
                        Skill level: Intermediate
                    {% endif %}
                    {% if recipe.difficulty == 'A challenge' %}
                        Skill level: Advanced
                    {% endif %}
                    <br></br>
                {% else %}
                {% endif %}
                Time needed: {{recipe.total_time}}
                <br></br>
                {% if recommended %}
                    {% if recipe.missing_count == 0 %}
                    All Good to Go!
                    {% else %}
                    # Missing Ingredients: {{recipe.missing_count}}
                    {% endif %}
                <br></br>
                {% endif %}

                {% for tag in recipe.restrictions %}
                    <button class="tight-wrap-button">{{tag}}</button>
                {% endfor %}
                <br></br>
                <form action="/remove_from_favorites" method="post">
                    <input type="hidden" name="recipe_id" value="{{recipe._id}}">
                    <button class="submit-button">Remove from Favorites</button>
                </form>
                </span>
                <div id="modal{{ loop.index }}" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('modal{{ loop.index }}')">&times;</span>
                        <h2><a href="/recipe_page?recipe={{recipe._id}}">{{recipe.title | safe}}</a></h2>
                        <a href="/recipe_page?recipe={{recipe._id}}">
                            <img src="{{ recipe.picture_url }}" width="500" height="400" style="display: block; margin: auto;">
                        </a>
                        <h3>Time needed: {{ recipe.total_time }}</h3>
        
                        {% if recipe.servings != "" and recipe.servings == recipe.servings %}
                        <h3>Number of Servings: {{ recipe.servings }}</h3>
                        {% elif recipe.makes != "" and recipe.makes == recipe.makes %}
                        <h3>Makes: {{ recipe.makes }}</h3>
                        {% endif %}
                        
        
                        {% if recommended %}
                            {% if recipe.missing_count == 0 %}
                                <h3>All Good to Go!</h3>
                            {% else %}
                                <h3># Missing Ingredients: {{recipe.missing_count}}</h3>
                            {% endif %}
                        {% endif %}
        
                        {% if recipe.difficulty in ['Easy', 'More effort', 'A challenge'] %}
                            {% if recipe.difficulty == 'Easy' %}
                                <h3>Skill level: Beginner</h3>
                            {% endif %}
                            {% if recipe.difficulty == 'More effort' %}
                                <h3>Skill level: Intermediate</h3>
                            {% endif %}
                            {% if recipe.difficulty == 'A challenge' %}
                                <h3>Skill level: Advanced</h3>
                            {% endif %}
                        {% endif %}
        
                        <div>
                            {% for tag in recipe.restrictions %}
                                <button class="tight-wrap-button">{{ tag }}</button>
                            {% endfor %}
                        </div>
                        <h3>Ingredient List</h3>
                        <ul>
                            {% for ingredient in recipe.actual_ingredients %}
                                <li>{{ ingredient }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>Your favorite recipe is empty.</p>
        {% endif %}
    </div>

        <script>
            
            document.addEventListener('DOMContentLoaded', function() {
                // Add enter key listener
                document.getElementById('search-input').addEventListener('keypress', function(e) {
                    if (e.key === "Enter") {
                        searchRecipes();
                    }
                });
            });
            function openModal(modalId) {
                document.getElementById(modalId).style.display = 'block';
            }

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            window.onclick = function(event) {
                const modals = document.getElementsByClassName('modal');
                for (let i = 0; i < modals.length; i++) {
                    if (event.target === modals[i]) {
                        modals[i].style.display = 'none'; // Close the modal
                    }
                }
            }

            function searchRecipes() {
                var searchRequest = null;
                console.log("Search function called");
                
                
                let searchTerm = $('#search-input').val().toLowerCase();
                let searchType = $('#search-type').val();

                console.log("Search term:", searchTerm);
                console.log("Search type:", searchType);
                console.log("Number of recipe boxes:", $('.inline-box').length);
                
                // Client-side filtering
                $('.inline-box').each(function() {
                    let $recipe = $(this);
                    let match = false;
                    
                    let title = $recipe.find('h4').text().toLowerCase();
                    let tags = $recipe.find('.tight-wrap-button').map(function() {
                        return $(this).text().toLowerCase();
                    }).get();
                    let difficulty = $recipe.text().includes('Skill level:') ? 
                        $recipe.text().split('Skill level:')[1].split('\n')[0].trim().toLowerCase() : '';
                    
                        console.log("Checking recipe:", {
                            title: title,
                            tags: tags,
                            difficulty: difficulty
                        });
                    switch(searchType) {
                        case 'title':
                            match = title.includes(searchTerm);
                            break;
                        case 'tags':
                            match = tags.some(tag => tag.includes(searchTerm));
                            break;
                        case 'difficulty':
                            match = difficulty.includes(searchTerm);
                            break;
                        case 'all':
                        default:
                            match = title.includes(searchTerm) || 
                                    tags.some(tag => tag.includes(searchTerm)) || 
                                    difficulty.includes(searchTerm);
                            break;
                    }
                    console.log("Match result:", match);
                    $(this).toggleClass('hidden', !match);
                });
            }


        </script>

</body>
</html>