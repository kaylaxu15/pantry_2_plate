<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="static/styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Your Finished Recipes</title>
    {% include 'header.html' %}
    <a href="/">
        <img class="logo" src="static/logo.png" alt="logo">
    </a>
    
</head>
<body>
    <h1>Your Finished Recipes</h1>
    <button onclick="history.back()" class="back-button">Go Back</button>
    <div class="search-box">
        <input type="text" id="search-input" name="search" placeholder="Search recipes...">
        <select id="search-type" name="search-type">
            <option value="all">All</option>
            <option value="title">Title</option>
            <option value="tags">Tags</option>
            <option value="difficulty">Skill Level</option>
        </select>
        <button onclick="searchRecipes()" class="search-button">Search</button>
    </div>
    <div class="completed-container">
        {% if completed %}
            {% for recipe in completed %}
            <span class="inline-box">
                <h4>{{ recipe.title | safe }}</h4>
                <img src="{{recipe.picture_url}}" width="150" height="150">
                <br></br>
                {% if recipe.servings != "" and recipe.servings == recipe.servings %}
                Number of Servings: {{ recipe.servings }}
                <br></br>
                {% elif recipe.makes != "" and recipe.makes == recipe.makes %}
                    Makes: {{ recipe.makes }}
                    <br></br>
                {% endif %}
                {% if recipe.difficulty in ['Easy', 'More effort', 'A challenge'] %}
                    {% if recipe.difficulty == 'Easy' %}
                        Skill level: Beginner
                    {% endif %}
                    {% if recipe.difficulty == 'More effort' %}
                        Skill level: Intermediate
                    {% endif %}
                    {% if recipe.difficulty == 'A challenge' %}
                        Skill level:: Advanced
                    {% endif %}
                    <br></br>
                {% else %}
                {% endif %}
                Time needed: {{recipe.total_time}}
                <br></br>
                {% if recommended %}
                    {% if recipe.missing_count == 0 %}
                    All Good to Go!
                    {% else %}
                    # Missing Ingredients: {{recipe.missing_count}}
                    {% endif %}
                <br></br>
                {% endif %}

                Tags: 
                {% for tag in recipe.restrictions %}
                    <button class="tight-wrap-button">{{tag}}</button>
                {% endfor %}
                <br></br>

                <div class="reviewbox">
                    <form id="reviewForm" onsubmit="addReview(event)" method="post">
                        <input type="text" id="review" name="review" value="{{reviews.recipeID}}">
                        <input type="hidden" name="recipe_id">
                        <button class="submit-button" id="review_button">Save Changes</button>
                    </form>
                </div>  

                <form id="favoritesForm" onsubmit="addToFavorites(event)" method="post">
                    <input type="hidden" name="recipe_id" value="{{ recipe._id }}">
                    <button class="submit-button">Add to Favorites</button>
                </form>
                </span>
            {% endfor %}
        {% else %}
            <p>Your finished recipes list is empty.</p>
        {% endif %}
    </div>
    
    <script>
        function addToFavorites(event) {
            event.preventDefault(); 

            const form = event.target;
            const formData = new FormData(form);

            const request = new XMLHttpRequest();
            request.open("POST", "/add_to_favorites", true);

            request.onload = function() {
                if (request.status === 200) {
                    alert("Favorited recipe!");
                } else {
                    alert("Failed to add recipe to wishlist. Please try again.");
                }
            };

            request.onerror = function() {
                alert("An error occurred. Please check your network connection.");
            };

            request.send(formData);
        }

        function convertToHtml(review) {
            let template = `{{review}}`
            let map = {review: review};
            let html = Mustache.render(template, map);
            return html;
        }

        function addReview(event) {
           event.preventDefault();


           const form = event.target;
           const formData = new FormData(form);


           const request = new XMLHttpRequest();
           request.open("POST", "/add_review", true);


           request.onload = function() {
               if (request.status === 200) {
                   alert("Saved Changes!");


               } else {
                   alert("Failed to save changes. Please try again.");
               }
           };


           request.onerror = function() {
               alert("An error occurred. Please check your network connection.");
           };


           request.send(formData);
       }

        // function getReviews() {
    
        //     let review = $('#review').val() || '';
        //     review = encodeURIComponent(review);

        //     let recipe_id = $('#recipe_id').val();
        //     recipe_id = encodeURIComponent(recipe_id);
            
        //     let requestData = {
        //         type: 'GET',
        //         url: '/add_review',
        //         success: handleResponse,
        //         error: handleError
        //     };

        //     request = $.ajax(requestData);
        // }

        // function handleResponse(review) {
        //     $('#reviewbox').html(convertToHtml(review));
        // }

        // function handleError(request) {
        //     if (request.statusText !== 'abort')
        //         alert('Error: Failed to fetch data from server');
        // }

        function searchRecipes() {
            var searchRequest = null;
            console.log("Search function called");
            
            
            let searchTerm = $('#search-input').val().toLowerCase();
            let searchType = $('#search-type').val();

            console.log("Search term:", searchTerm);
            console.log("Search type:", searchType);
            console.log("Number of recipe boxes:", $('.inline-box').length);
            
            // Client-side filtering
            $('.inline-box').each(function() {
                let $recipe = $(this);
                let match = false;
                
                let title = $recipe.find('h4').text().toLowerCase();
                let tags = $recipe.find('.tight-wrap-button').map(function() {
                    return $(this).text().toLowerCase();
                }).get();
                let difficulty = $recipe.text().includes('Skill level:') ? 
                    $recipe.text().split('Skill level:')[1].split('\n')[0].trim().toLowerCase() : '';
                
                    console.log("Checking recipe:", {
                        title: title,
                        tags: tags,
                        difficulty: difficulty
                    });
                switch(searchType) {
                    case 'title':
                        match = title.includes(searchTerm);
                        break;
                    case 'tags':
                        match = tags.some(tag => tag.includes(searchTerm));
                        break;
                    case 'difficulty':
                        match = difficulty.includes(searchTerm);
                        break;
                    case 'all':
                    default:
                        match = title.includes(searchTerm) || 
                                tags.some(tag => tag.includes(searchTerm)) || 
                                difficulty.includes(searchTerm);
                        break;
                }
                console.log("Match result:", match);
                $(this).toggleClass('hidden', !match);
            })
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Add enter key listener
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === "Enter") {
                    searchRecipes();
                }
            });
        });
        
    </script>
</body>
</html>